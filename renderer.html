<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Instalily Fathom Assistant</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f8f8fa;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #1a1a1a;
    }

    .hidden {
      display: none !important;
    }

    .container {
      width: 100%;
      max-width: 420px;
      padding: 20px;
    }

    .login-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      padding: 48px 40px;
      text-align: center;
    }

    .logo-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 48px;
    }

    .logo-img {
      height: 48px;
      width: auto;
      object-fit: contain;
    }

    .connection-icon {
      width: 24px;
      height: 24px;
      object-fit: contain;
      opacity: 0.7;
      flex-shrink: 0;
    }

    .title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #1a1a1a;
    }

    .subtitle {
      font-size: 16px;
      color: #6b7280;
      line-height: 1.5;
      margin-bottom: 40px;
    }

    .login-btn {
      width: 100%;
      padding: 14px 24px;
      background: #1a1a1a;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .login-btn:hover {
      background: #2a2a2a;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .login-btn.waiting {
      background: #6b7280;
      cursor: not-allowed;
    }

    .login-btn.success {
      background: #00beff;
    }

    .status-icon {
      width: 20px;
      height: 20px;
      display: none;
    }

    .login-btn.waiting .status-icon,
    .login-btn.success .status-icon {
      display: inline-block;
    }

    .footer {
      margin-top: 32px;
      font-size: 14px;
      color: #9ca3af;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      animation: spin 1s linear infinite;
    }

    /* Logged in state styles */
    .user-info {
      padding: 24px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      text-align: center;
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 32px;
      font-weight: 600;
      color: #6b7280;
      overflow: hidden;
    }

    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .user-name {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .user-email {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 16px;
    }

    .user-info .subtitle {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.5;
      margin-bottom: 24px;
      padding: 0 20px;
    }

    .status-list {
      list-style: none;
      padding: 16px 0;
      border-top: 1px solid #e5e7eb;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 24px;
    }

    .status-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }

    .status-label {
      font-size: 14px;
      color: #6b7280;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 500;
    }

    .status-badge.connected {
      color: #00beff;
    }

    .status-badge.disconnected {
      color: #ef4444;
    }

    .status-icon {
      width: 16px;
      height: 16px;
    }

    .logout-btn {
      width: 100%;
      padding: 12px 20px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .logout-btn:hover {
      background: #b91c1c;
    }

    .close-btn {
      width: 100%;
      padding: 12px 20px;
      background: #1a1a1a;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 12px;
    }

    .close-btn:hover {
      background: #2a2a2a;
    }

    .complete-message {
      margin-top: 16px;
      margin-bottom: 24px;
      padding: 12px;
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 8px;
      font-size: 14px;
      color: #166534;
      line-height: 1.5;
    }

    .user-info .logo-container {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 24px;
    }

    .user-info .logo-img {
      height: 40px;
      width: auto;
      object-fit: contain;
    }

    .user-info .connection-icon {
      width: 20px;
      height: 20px;
      object-fit: contain;
      opacity: 0.7;
      flex-shrink: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Card (shown when not logged in) -->
    <div id="loginCard" class="login-card">
      <div class="logo-container">
        <img src="resources/logos/InstaLILY AI Logo.png" alt="Instalily" class="logo-img">
        <img src="resources/images/chain_link.png" alt="Connect" class="connection-icon">
        <img src="resources/logos/Fathom Video Logo.png" alt="Fathom" class="logo-img">
      </div>
      
      <h2 class="title">Cosailor Fathom Integration</h2>
      <p class="subtitle">
        Sign in to Google and Fathom.video to automatically setup Google Drive transcript export for Instalily internal Cosailor.
      </p>
      
      <button id="googleBtn" class="login-btn">
        <svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 11l3 3L22 4" />
        </svg>
        <span id="googleBtnText">Sign in with Google</span>
      </button>
      
      <button id="fathomBtn" class="login-btn" style="display: none; margin-top: 16px;">
        <svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 11l3 3L22 4" />
        </svg>
        <span id="fathomBtnText">Connect to Fathom</span>
      </button>
      
      <p class="footer" id="footerText">
        You'll be redirected back after signing in
      </p>
    </div>
    
    <!-- User Info Card (shown when logged in) -->
    <div id="userCard" class="user-info hidden">
      <div class="logo-container">
        <img src="resources/logos/InstaLILY AI Logo.png" alt="Instalily" class="logo-img">
        <img src="resources/images/chain_link.png" alt="Connect" class="connection-icon">
        <img src="resources/logos/Fathom Video Logo.png" alt="Fathom" class="logo-img">
      </div>
      <div class="user-avatar" id="userAvatar"></div>
      <div class="user-name" id="userName"></div>
      <div class="user-email" id="userEmail"></div>
      
      <p class="subtitle">
        Sign in to Google and Fathom.video to automatically setup Google Drive transcript export for Instalily internal Cosailor.
      </p>
      
      <ul class="status-list">
        <li class="status-item">
          <span class="status-label">Google Account</span>
          <div id="googleStatus" class="status-badge">
            <svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Connected</span>
          </div>
        </li>
        <li class="status-item">
          <span class="status-label">Fathom Account</span>
          <div id="fathomStatus" class="status-badge">
            <svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Connected</span>
          </div>
        </li>
      </ul>
      
      <button id="connectFathomBtn" class="login-btn hidden" style="margin-bottom: 16px;">
        Connect to Fathom
      </button>
      
      <div id="completeMessage" class="complete-message hidden">
        Setup complete! Instalily Fathom Assistant will do the rest in the cloud. You may close the app.
      </div>
      
      <button id="closeBtn" class="close-btn hidden">
        Close App
      </button>
      
      <button id="logoutBtn" class="logout-btn">
        Log Out
      </button>
    </div>
  </div>
  
  <script>
    // UI Elements
    const loginCard = document.getElementById('loginCard');
    const userCard = document.getElementById('userCard');
    const googleBtn = document.getElementById('googleBtn');
    const fathomBtn = document.getElementById('fathomBtn');
    const googleBtnText = document.getElementById('googleBtnText');
    const fathomBtnText = document.getElementById('fathomBtnText');
    const googleStatusIcon = googleBtn.querySelector('.status-icon');
    const fathomStatusIcon = fathomBtn.querySelector('.status-icon');
    const footerText = document.getElementById('footerText');
    
    // User card elements
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const googleStatus = document.getElementById('googleStatus');
    const fathomStatus = document.getElementById('fathomStatus');
    const connectFathomBtn = document.getElementById('connectFathomBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const closeBtn = document.getElementById('closeBtn');
    const completeMessage = document.getElementById('completeMessage');
    
    // Check URL parameters for status updates
    const urlParams = new URLSearchParams(window.location.search);
    
    // Function to show user info
    function showUserInfo(sessionData) {
      loginCard.classList.add('hidden');
      userCard.classList.remove('hidden');
      
      // Set user info
      userName.textContent = sessionData.name || 'User';
      userEmail.textContent = sessionData.email;
      
      // Set avatar - use profile picture if available, otherwise use initial
      if (sessionData.picture) {
        userAvatar.innerHTML = `<img src="${sessionData.picture}" alt="${sessionData.name || 'User'}" />`;
      } else {
        userAvatar.textContent = (sessionData.name || sessionData.email || 'U').charAt(0).toUpperCase();
      }
      
      // Update connection status
      if (sessionData.hasGoogleAuth) {
        googleStatus.classList.add('connected');
        googleStatus.classList.remove('disconnected');
        googleStatus.innerHTML = `
          <svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Connected</span>
        `;
      } else {
        googleStatus.classList.add('disconnected');
        googleStatus.classList.remove('connected');
        googleStatus.innerHTML = `
          <svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Not Connected</span>
        `;
      }
      
      if (sessionData.hasFathomAuth) {
        fathomStatus.classList.add('connected');
        fathomStatus.classList.remove('disconnected');
        fathomStatus.innerHTML = `
          <svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Connected</span>
        `;
        connectFathomBtn.classList.add('hidden');
        if (sessionData.hasGoogleAuth) {
          completeMessage.classList.remove('hidden');
          closeBtn.classList.remove('hidden');
        }
      } else {
        fathomStatus.classList.add('disconnected');
        fathomStatus.classList.remove('connected');
        fathomStatus.innerHTML = `
          <svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span>Not Connected</span>
        `;
        closeBtn.classList.add('hidden');
        if (sessionData.hasGoogleAuth) {
          connectFathomBtn.classList.remove('hidden');
        }
      }
    }
    
    // Check for existing session on load
    async function checkSession() {
      // First check URL params for session data (from main process)
      const sessionDataParam = urlParams.get('sessionData');
      if (sessionDataParam) {
        try {
          const sessionData = JSON.parse(decodeURIComponent(sessionDataParam));
          showUserInfo(sessionData);
          return;
        } catch (error) {
          console.error('Failed to parse session data from URL:', error);
        }
      }
      
      // Otherwise check via IPC
      try {
        const sessionData = await window.electronAPI.checkSession();
        if (sessionData) {
          showUserInfo(sessionData);
        }
      } catch (error) {
        console.error('Failed to check session:', error);
      }
    }
    
    // Check session on page load
    checkSession();
    
    // Handle Google OAuth error
    if (urlParams.get('googleAuth') === 'error') {
      googleBtn.classList.remove('waiting');
      googleBtn.disabled = false;
      googleStatusIcon.classList.remove('spinner');
      googleBtnText.innerText = 'Sign in with Google (Retry)';
      footerText.innerText = 'Google authentication failed. Please try again.';
    }
    
    // Google OAuth button handler
    googleBtn.onclick = async () => {
      googleBtn.classList.add('waiting');
      googleBtn.disabled = true;
      
      // Change to spinner icon
      googleStatusIcon.innerHTML = '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" transform="rotate(-90 12 12)"/>';
      googleStatusIcon.classList.add('spinner');
      googleBtnText.innerText = 'Waiting for Google sign-in...';
      footerText.innerText = 'Complete the Google sign-in process';
      
      try {
        const result = await window.electronAPI.startGoogleOAuth();
        
        if (!result.success) {
          // Handle error
          googleBtn.classList.remove('waiting');
          googleBtn.disabled = false;
          googleStatusIcon.classList.remove('spinner');
          googleBtnText.innerText = 'Sign in with Google (Retry)';
          footerText.innerText = result.error === 'timeout' ? 'Google sign-in timed out. Please try again.' : 'Google sign-in failed. Please try again.';
        }
        // Success is handled by the session data passed through URL params
      } catch (error) {
        console.error('Google OAuth error:', error);
        googleBtn.classList.remove('waiting');
        googleBtn.disabled = false;
        googleStatusIcon.classList.remove('spinner');
        googleBtnText.innerText = 'Sign in with Google (Retry)';
        footerText.innerText = 'An error occurred. Please try again.';
      }
    };
    
    // Fathom login button handler
    fathomBtn.onclick = async () => {
      fathomBtn.classList.add('waiting');
      fathomBtn.disabled = true;
      
      // Change to spinner icon
      fathomStatusIcon.innerHTML = '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" transform="rotate(-90 12 12)"/>';
      fathomStatusIcon.classList.add('spinner');
      fathomBtnText.innerText = 'Waiting for Fathom login...';
      footerText.innerText = 'Complete the Fathom sign-in process';
      
      try {
        const result = await window.electronAPI.startLogin();
        
        if (result !== 'done') {
          // Handle timeout or error
          fathomBtn.classList.remove('waiting');
          fathomBtn.disabled = false;
          fathomStatusIcon.classList.remove('spinner');
          fathomBtnText.innerText = 'Connect to Fathom (Retry)';
          footerText.innerText = result === 'timeout' ? 'Fathom login timed out. Please try again.' : 'Fathom login failed. Please try again.';
        }
        // Success is handled by the session data passed through URL params
      } catch (error) {
        console.error('Fathom login error:', error);
        fathomBtn.classList.remove('waiting');
        fathomBtn.disabled = false;
        fathomStatusIcon.classList.remove('spinner');
        fathomBtnText.innerText = 'Connect to Fathom (Retry)';
        footerText.innerText = 'An error occurred. Please try again.';
      }
    };
    
    // Logout button handler
    logoutBtn.onclick = async () => {
      try {
        const result = await window.electronAPI.logout();
        if (result.success) {
          // Clear URL parameters and reload by navigating to base file
          const baseUrl = window.location.href.split('?')[0];
          window.location.href = baseUrl;
        } else {
          alert('Failed to logout. Please try again.');
        }
      } catch (error) {
        console.error('Logout error:', error);
        alert('An error occurred while logging out.');
      }
    };
    
    // Connect Fathom button handler (for logged-in users without Fathom)
    connectFathomBtn.onclick = async () => {
      connectFathomBtn.disabled = true;
      connectFathomBtn.textContent = 'Connecting...';
      
      try {
        const result = await window.electronAPI.startLogin();
        
        if (result !== 'done') {
          connectFathomBtn.disabled = false;
          connectFathomBtn.textContent = 'Connect to Fathom (Retry)';
          alert(result === 'timeout' ? 'Fathom login timed out. Please try again.' : 'Fathom login failed. Please try again.');
        }
        // Success is handled by the session data passed through URL params
      } catch (error) {
        console.error('Fathom login error:', error);
        connectFathomBtn.disabled = false;
        connectFathomBtn.textContent = 'Connect to Fathom (Retry)';
        alert('An error occurred. Please try again.');
      }
    };
    
    // Close app button handler
    closeBtn.onclick = () => {
      window.electronAPI.closeApp();
    };
  </script>
</body>
</html>
